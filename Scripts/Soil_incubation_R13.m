clear; clc
data=[0.04	0.03	0.03	0.13	0.16	0.13	0.02	0.02	0.02	0.00	0.00	0.00	0.14	0.12	0.13	0.49	0.56	0.62	0.05	0.05	0.05	0.00	0.00	0.00
0.16	0.13	0.17	1.15	0.96	1.05	0.59	0.65	0.61	0.00	0.00	0.00	0.26	0.28	0.29	0.77	0.72	0.60	0.13	0.12	0.11	0.02	0.01	0.03
0.35	0.34	0.41	2.15	1.83	2.32	1.05	1.07	1.12	0.00	0.00	0.00	0.29	0.34	0.28	0.32	0.28	0.27	0.19	0.17	0.16	0.09	0.10	0.09
0.67	0.63	0.63	3.19	2.99	3.15	2.16	2.11	2.08	0.00	0.00	0.00	0.16	0.15	0.18	0.24	0.25	0.28	0.19	0.18	0.26	0.18	0.15	0.13
0.90	0.78	0.84	3.98	3.57	3.88	2.57	2.54	2.65	0.00	0.00	0.00	0.15	0.16	0.13	0.00	0.00	0.00	0.36	0.36	0.02	0.08	0.08	0.03
0.92	0.82	0.90	4.18	3.82	4.16	2.62	2.63	2.75	0.00	0.00	0.00	0.08	0.12	0.11	0.00	0.00	0.00	0.45	0.43	0.42	0.05	0.03	0.03
0.04	0.03	0.03	0.13	0.16	0.13	0.02	0.02	0.02	0.00	0.00	0.00	0.14	0.12	0.13	0.49	0.56	0.62	0.05	0.05	0.05	0.00	0.00	0.00
0.11	0.12	0.11	1.18	1.09	1.09	0.26	0.21	0.23	0.57	0.37	0.39	0.06	0.09	0.10	0.59	0.62	0.53	0.11	0.12	0.13	0.00	0.00	0.00
0.19	0.17	0.19	2.12	1.82	2.25	0.26	0.25	0.24	0.85	0.86	0.97	0.04	0.05	0.04	0.20	0.11	0.16	0.14	0.13	0.13	0.01	0.01	0.01
0.42	0.44	0.36	3.13	3.11	3.10	0.51	0.43	0.45	3.24	3.20	2.92	0.02	0.03	0.04	0.16	0.12	0.15	0.18	0.19	0.18	0.02	0.08	0.09
0.44	0.48	0.40	4.23	4.39	4.21	0.63	0.55	0.58	8.69	8.34	7.62	0.02	0.02	0.02	0.01	0.02	0.00	0.19	0.19	0.20	0.10	0.15	0.14
0.46	0.49	0.41	4.38	4.61	4.50	0.71	0.61	0.64	9.38	9.24	9.56	0.00	0.00	0.00	0.00	0.00	0.00	0.25	0.23	0.24	0.11	0.10	0.11
0.04	0.03	0.03	0.13	0.16	0.13	0.02	0.02	0.02	0.00	0.00	0.00	0.14	0.12	0.13	0.49	0.56	0.62	0.05	0.05	0.05	0.00	0.00	0.00
0.07	0.07	0.07	0.77	0.61	0.74	0.08	0.08	0.08	0.00	0.00	0.00	0.15	0.14	0.15	0.59	0.52	0.54	0.08	0.07	0.07	0.00	0.00	0.00
0.11	0.09	0.12	2.21	2.42	2.34	0.07	0.08	0.07	0.00	0.00	0.00	0.16	0.16	0.16	0.34	0.35	0.34	0.13	0.13	0.13	0.00	0.00	0.01
0.25	0.20	0.24	4.92	5.15	4.60	0.08	0.08	0.08	0.00	0.00	0.00	0.06	0.07	0.11	0.07	0.07	0.07	0.21	0.17	0.20	0.00	0.00	0.00
0.40	0.31	0.32	6.60	6.61	6.36	0.08	0.08	0.08	0.00	0.00	0.00	0.05	0.04	0.05	0.00	0.00	0.00	0.41	0.40	0.71	0.00	0.00	0.00
0.50	0.35	0.35	6.82	6.88	6.91	0.08	0.08	0.08	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.46	0.48	0.45	0.00	0.00	0.00
0.04	0.03	0.03	0.13	0.16	0.13	0.02	0.02	0.02	0.00	0.00	0.00	0.14	0.12	0.13	0.49	0.56	0.62	0.05	0.05	0.05	0.00	0.00	0.00
0.05	0.05	0.06	0.94	0.75	1.06	0.06	0.06	0.05	0.00	0.00	0.00	0.05	0.07	0.08	0.51	0.58	0.53	0.08	0.06	0.07	0.00	0.00	0.00
0.13	0.11	0.14	2.38	2.00	2.67	0.07	0.08	0.07	2.58	2.02	3.24	0.00	0.00	0.00	0.00	0.00	0.00	0.01	0.01	0.01	0.00	0.00	0.00
0.24	0.24	0.25	5.22	4.14	4.60	0.07	0.08	0.07	2.77	3.32	3.39	0.00	0.00	0.00	0.00	0.00	0.00	0.01	0.01	0.01	0.00	0.00	0.00
0.30	0.29	0.30	6.96	6.55	7.01	0.08	0.08	0.08	4.44	4.42	5.49	0.00	0.00	0.00	0.00	0.00	0.00	0.01	0.00	0.01	0.00	0.00	0.00
0.33	0.34	0.34	7.62	6.91	7.67	0.08	0.08	0.08	4.53	6.86	5.61	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.01	0.00	0.00	0.00];

i=0;
j=0;
col=colormap(hsv(4));

t={'None','Sulfate','O2','Both'};

a=[0, 0, 4, 0, 2, 0, -2, -4, 0, 0, -1, 2, 2; %H2
    6, 0, 2, 2, 1, 1, 0, -1, 1, 1, 1, 2, 0; % Co2
    0, 0, 0, 0, 0, 0, 0, 1, 1, -1, -1, 0, 0; % CH4
    0, 0, 0, 0, 0, 0.5, 0.5, 0, 0, 0, 1, 0, 0; % H2S
    0, 2, 0, 0, -1, -1, 0, 0, 0, 0, 0, 0, 0; % lactate
    0, 0, 2, 1, 1, 1, 0, 0, -1, 0, 0, 0, -3; % acetate
    0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, -6; % ethanol
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 3]; %butyrate

l=size(a,1);
for c=1:4
  j=j+1;
  if c==1
      b=[zeros(l,1) a(:,2:5) zeros(l,2) a(:,8:9) zeros(l,2) a(:,12:13)];
  elseif c==2
      b=[zeros(l,1) a(:,2:9) zeros(l,1) a(:,11:13)];
  elseif c==3
      b=[a(:,1:5) zeros(l,2) a(:,8:10) zeros(l,1) a(:,12:13)];
  elseif c==4
      b=[a(:,1:13)];
  end
  for rep=1:3
    for d=1:6
      i=i+1;
      p(i,:)=data(((c-1)*6+d),[1 4 7 10 13 16 19 22]+rep-1); 
      sol2(:,i) = lsqnonneg(b,p(i,:)');  
      cm(i,:)=b*sol2(1:end,i);
      
      
    end
   
    subplot(2,2,j);plot(1:6,cm(i-5:i,1),':r',1:6,cm(i-5:i,2),':b',1:6,cm(i-5:i,3),':g',1:6,cm(i-5:i,4),':k',1:6,cm(i-5:i,5),'--r',1:6,cm(i-5:i,6),'--b',1:6,cm(i-5:i,7),'--g',1:6,cm(i-5:i,8),'-k','LineWidth', 2);
    hold on; 
    plot(1:6,p(i-5:i,1),'*r',1:6,p(i-5:i,2),'*b',1:6,p(i-5:i,3),'*g',1:6,p(i-5:i,4),'*k',1:6,p(i-5:i,5),'or',1:6,p(i-5:i,6),'ob',1:6,p(i-5:i,7),'og',1:6,p(i-5:i,8),'ok')
    
    axis([0 6 0 1.5]);
    title(t{j})
  end
  
  if c==1
     legend({'H2','CH4','H2S','lactate','acetate','ethanol','butyrate','H2','CH4','H2S','lactate','acetate','ethanol','butyrate'});
end
end
  
